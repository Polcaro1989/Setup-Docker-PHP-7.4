name: CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build and start the application
      run: |
        docker-compose up --build -d

    - name: Get container information
      id: container_info
      run: |
        CONTAINER_ID=$(docker-compose ps -q)
        CONTAINER_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $CONTAINER_ID)
        APP_PORT=$(docker inspect -f '{{(index (index .NetworkSettings.Ports "8085/tcp") 0).HostPort}}' $CONTAINER_ID)
        PHPMYADMIN_PORT=$(docker inspect -f '{{(index (index .NetworkSettings.Ports "9095/tcp") 0).HostPort}}' $CONTAINER_ID)
        echo "The application is running at http://$CONTAINER_IP:$APP_PORT"
        echo "PHPMyAdmin is running at http://$CONTAINER_IP:$PHPMYADMIN_PORT"
        echo "::set-output name=container_ip::$CONTAINER_IP"
        echo "::set-output name=app_port::$APP_PORT"
        echo "::set-output name=phpmyadmin_port::$PHPMYADMIN_PORT"

    - name: Access application
      run: |
        echo "Accessing application at http://${{ steps.container_info.outputs.container_ip }}:${{ steps.container_info.outputs.app_port }}"
        echo "Accessing PHPMyAdmin at http://${{ steps.container_info.outputs.container_ip }}:${{ steps.container_info.outputs.phpmyadmin_port }}"

    - name: Access container
      run: |
        docker-compose exec -it service_name bash
